<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title layout:title-pattern="CONTENT_TITLE - LAYOUT_TITLE">Cửa hàng công nghệ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#facc15', // Màu vàng tuỳ chỉnh
                    },
                }
            }
        }
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <style>
        .carousel-item {
            transition: opacity 0.7s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .carousel-item:not(.opacity-100) {
            opacity: 0;
            pointer-events: none;
        }
        .carousel-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-white text-black flex flex-col min-h-screen">

<!-- Header -->
<div th:replace="fragmentsHome/header :: header"></div>

<!-- Main content -->
<main class="flex-grow">
    <div layout:fragment="content"></div>


</main>

<!-- Footer -->
<div th:replace="fragmentsHome/footer :: footer"></div>

<!-- Carousel script -->
<script>
    class Carousel {
        constructor(element) {
            this.carousel = element;
            this.items = element.querySelectorAll('[data-carousel-item]');
            this.indicators = element.querySelectorAll('[data-carousel-slide-to]');
            this.prevButton = element.querySelector('[data-carousel-prev]');
            this.nextButton = element.querySelector('[data-carousel-next]');
            this.currentIndex = 0;
            this.isTransitioning = false;
            this.autoplayInterval = null;
            this.init();
        }

        init() {
            if (this.items.length === 0) return;
            this.updateSlide(0);
            this.prevButton?.addEventListener('click', () => this.prev());
            this.nextButton?.addEventListener('click', () => this.next());
            this.indicators.forEach((el, i) =>
                el.addEventListener('click', () => this.goToSlide(i))
            );
            this.startAutoplay();
            this.carousel.addEventListener('mouseenter', () => this.stopAutoplay());
            this.carousel.addEventListener('mouseleave', () => this.startAutoplay());
            this.carousel.carouselInstance = this;
        }

        updateSlide(index) {
            if (this.isTransitioning || index === this.currentIndex) return;
            this.isTransitioning = true;
            this.items.forEach((item, i) => {
                item.classList.toggle('opacity-100', i === index);
                item.classList.toggle('opacity-0', i !== index);
            });
            this.indicators.forEach((indicator, i) => {
                indicator.classList.toggle('opacity-100', i === index);
                indicator.classList.toggle('opacity-50', i !== index);
                indicator.setAttribute('aria-current', i === index ? 'true' : 'false');
            });
            this.currentIndex = index;
            setTimeout(() => this.isTransitioning = false, 700);
        }

        next() {
            this.updateSlide((this.currentIndex + 1) % this.items.length);
        }

        prev() {
            this.updateSlide((this.currentIndex - 1 + this.items.length) % this.items.length);
        }

        goToSlide(index) {
            if (index >= 0 && index < this.items.length) this.updateSlide(index);
        }

        startAutoplay() {
            if (this.items.length <= 1) return;
            this.stopAutoplay();
            this.autoplayInterval = setInterval(() => this.next(), 3000);
        }

        stopAutoplay() {
            clearInterval(this.autoplayInterval);
            this.autoplayInterval = null;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const defaultCarousel = document.getElementById('default-carousel');
        if (defaultCarousel) new Carousel(defaultCarousel);

        const productCarousel = document.getElementById('product-highlights-carousel');
        if (productCarousel) new Carousel(productCarousel);
    });

    document.addEventListener('touchstart', e => {
        window.touchStartX = e.touches[0].clientX;
        window.touchStartY = e.touches[0].clientY;
        window.activeCarouselInstance = e.target.closest('[data-carousel-container]')?.carouselInstance;
    }, { passive: true });

    document.addEventListener('touchend', e => {
        if (!window.activeCarouselInstance) return;
        const dx = e.changedTouches[0].clientX - window.touchStartX;
        const dy = e.changedTouches[0].clientY - window.touchStartY;

        if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
            dx > 0 ? window.activeCarouselInstance.prev() : window.activeCarouselInstance.next();
        }
        window.activeCarouselInstance = null;
    }, { passive: true });

    document.addEventListener('keydown', e => {
        const carousels = document.querySelectorAll('[data-carousel-container]');
        carousels.forEach(carouselElement => {
            if (carouselElement.carouselInstance) {
                const isVisible = Array.from(carouselElement.carouselInstance.items).some(
                    item => item.classList.contains('opacity-100')
                );
                if (isVisible) {
                    if (e.key === 'ArrowLeft') {
                        carouselElement.carouselInstance.prev();
                        e.preventDefault();
                    }
                    if (e.key === 'ArrowRight') {
                        carouselElement.carouselInstance.next();
                        e.preventDefault();
                    }
                }
            }
        });
    });
</script>

<!-- Cart helper script -->
<script>
    function updateCartBadge(count) {
        const badge = document.getElementById('cart-count');
        if (!badge) return;
        badge.textContent = count;
        if (count > 0) {
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    // Global addToCart function => có thể gọi ở mọi trang
    window.addToCart = function(productId, quantity = 1) {
        fetch(`/cart/add/${productId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `quantity=${quantity}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updateCartBadge(data.itemCount);
                alert(data.message);
            } else {
                alert(data.message || 'Có lỗi xảy ra.');
            }
        })
        .catch(() => alert('Có lỗi xảy ra khi thêm sản phẩm.'));
    }

    // Global addToWishlist function
    window.addToWishlist = function(productId, btn) {
        fetch('/wishlist/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `productId=${productId}`
        })
        .then(res => res.text())
        .then(data => {
            if (data === 'success') {
                window.location.reload(); // Reload lại trang để cập nhật trạng thái
            } else if (data === 'exists') {
                // Nếu đã có, thì xoá khỏi wishlist
                fetch('/wishlist/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `productId=${productId}`
                })
                .then(res => res.text())
                .then(rm => {
                    if (rm === 'success') {
                        window.location.reload();
                    } else if (rm === 'not_logged_in') {
                        window.location.href = '/auth/login';
                    } else {
                        alert('Có lỗi khi xoá khỏi yêu thích.');
                    }
                })
                .catch(() => alert('Có lỗi khi xoá khỏi yêu thích.'));
            } else if (data === 'not_logged_in') {
                window.location.href = '/auth/login'; // Chuyển hướng đăng nhập
            } else {
                alert('Có lỗi xảy ra khi thêm vào yêu thích.');
            }
        })
        .catch(() => alert('Có lỗi xảy ra khi thêm vào yêu thích.'));
    }

    // Global removeFromWishlist function (nếu cần)
    window.removeFromWishlist = function(productId, btn) {
        fetch('/wishlist/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `productId=${productId}`
        })
        .then(res => res.text())
        .then(data => {
            if (data === 'success') {
                if (btn) {
                    btn.classList.remove('bg-red-500', 'text-white');
                    btn.classList.add('bg-white', 'text-red-500');
                    btn.title = 'Thêm vào yêu thích';
                }
                alert('Đã xóa khỏi danh sách yêu thích!');
            } else if (data === 'not_logged_in') {
                alert('Vui lòng đăng nhập để sử dụng chức năng yêu thích!');
                window.location.href = '/auth/login';
            } else {
                alert('Có lỗi xảy ra khi xóa khỏi yêu thích.');
            }
        })
        .catch(() => alert('Có lỗi xảy ra khi xóa khỏi yêu thích.'));
    }
</script>
</body>
</html>
